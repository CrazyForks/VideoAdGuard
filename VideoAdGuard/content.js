/*! For license information please see content.js.LICENSE.txt */
(()=>{var e={27:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AIService=void 0,t.AIService=class{static async makeRequest(e,t){const o={model:await this.getModel(),messages:[{role:"system",content:"你是一个敏感的视频观看者，能根据视频的连贯性改变和宣传推销类内容，找出视频中可能存在的植入广告。内容如果和主题相关，即使是推荐/评价也可能只是分享而不是广告，重点要看有没有提到通过视频博主可以受益的渠道进行购买。"},{role:"user",content:this.buildPrompt(e)}],temperature:0,max_tokens:1024,stream:!1,...t.bodyExtra},i=await chrome.runtime.sendMessage({url:await this.getApiUrl(),headers:t.headers,body:o});if(console.log("【VideoAdGuard】API请求已发送"),i.success)return console.log("【VideoAdGuard】收到API响应:",i.data),i.data;throw console.error("【VideoAdGuard】请求失败:",i.error),new Error(i.error)}static async detectAd(e){if(console.log("【VideoAdGuard】开始分析视频信息:",e),await this.getEnableLocalOllama()){const t=await this.makeRequest(e,{headers:{"Content-Type":"application/json"},bodyExtra:{format:"json"}});return JSON.parse(t.message.content)}{const t=await this.getApiKey();if(!t)throw new Error("未设置API密钥");console.log("【VideoAdGuard】成功获取API密钥");const o=await this.getApiUrl(),i=(await this.getModel(),o.includes("api.openai.com")),n=o.includes("openai.azure.com"),r=o.includes("open.bigmodel.cn"),s=o.includes("api.deepseek.com"),a=o.includes("aliyuncs.com"),c={};return(i||n||r||s||a)&&(c.response_format={type:"json_object"}),(await this.makeRequest(e,{headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},bodyExtra:Object.keys(c).length?c:void 0})).choices[0].message.content}}static buildPrompt(e){const t=`视频的标题和置顶评论如下，可供参考判断是否有植入广告。如果置顶评论中有购买链接，则肯定有广告，同时可以根据置顶评论的内容判断视频中的广告商从而确定哪部分是广告。\n视频标题：${e.title}\n置顶评论：${e.topComment||"无"}\n下面我会给你这个视频的字幕字典，形式为 index: context. 请你完整地找出其中的植入广告，返回json格式的数据。注意要返回一整段的广告，从广告的引入到结尾重新转折回到视频内容前，因此不要返回太短的广告，可以组合成一整段返回。\n字幕内容：${JSON.stringify(e.captions)}\n示例输出：\n{\n  "exist": <bool. true表示存在植入广告，false表示不存在植入广告>,\n  "index_lists": <list[list[int]]. 二维数组，行数表示广告的段数，不要返回过多段，只返回与标题最不相关或者与置顶链接中的商品最相关的部分。每一行是长度为2的数组[start, end]，表示一段完整广告的开头结尾，start和end是字幕的index。>\n}`;return console.log("【VideoAdGuard】构建提示词成功:",t),t}static async getApiUrl(){console.log("【VideoAdGuard】正在获取API地址");const e=await chrome.storage.local.get("apiUrl");return console.log("【VideoAdGuard】API地址状态:",e.apiUrl?"已设置":"未设置"),e.apiUrl||"https://open.bigmodel.cn/api/paas/v4/chat/completions"}static async getApiKey(){console.log("【VideoAdGuard】正在获取API密钥");const e=await chrome.storage.local.get("apiKey");return console.log("【VideoAdGuard】API密钥状态:",e.apiKey?"已设置":"未设置"),e.apiKey||null}static async getModel(){console.log("【VideoAdGuard】正在获取模型名称");const e=await chrome.storage.local.get("model");return console.log("【VideoAdGuard】模型名称状态:",e.model?"已设置":"未设置"),e.model||"glm-4-flash"}static async getEnableLocalOllama(){console.log("【VideoAdGuard】正在获取本地Ollama设置");const e=await chrome.storage.local.get("enableLocalOllama");return console.log("【VideoAdGuard】本地Ollama设置状态:",e.enableLocalOllama?"已设置":"未设置"),e.enableLocalOllama||!1}}},151:e=>{var t={utf8:{stringToBytes:function(e){return t.bin.stringToBytes(unescape(encodeURIComponent(e)))},bytesToString:function(e){return decodeURIComponent(escape(t.bin.bytesToString(e)))}},bin:{stringToBytes:function(e){for(var t=[],o=0;o<e.length;o++)t.push(255&e.charCodeAt(o));return t},bytesToString:function(e){for(var t=[],o=0;o<e.length;o++)t.push(String.fromCharCode(e[o]));return t.join("")}}};e.exports=t},206:e=>{function t(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}e.exports=function(e){return null!=e&&(t(e)||function(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&t(e.slice(0,0))}(e)||!!e._isBuffer)}},237:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BilibiliService=void 0;const i=o(974);t.BilibiliService=class{static async fetchWithCookie(e,t={}){const o=`${e}?${new URLSearchParams(t).toString()}`;console.log("【VideoAdGuard】[BilibiliService] Fetching URL:",o);const i=await fetch(o,{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",Referer:"https://www.bilibili.com/"},credentials:"include"}),n=await i.json();if(console.log("【VideoAdGuard】[BilibiliService] Response data:",n),0!==n.code)throw new Error(n.message);return n.data}static async getVideoInfo(e){console.log("【VideoAdGuard】[BilibiliService] Getting video info for bvid:",e);const t=await this.fetchWithCookie("https://api.bilibili.com/x/web-interface/view",{bvid:e});return console.log("【VideoAdGuard】[BilibiliService] Video info result:",t),t}static async getComments(e){console.log("【VideoAdGuard】[BilibiliService] Getting comments for bvid:",e);const t=await this.fetchWithCookie("https://api.bilibili.com/x/v2/reply",{oid:e,type:1});return console.log("【VideoAdGuard】[BilibiliService] Comments result:",t),t}static async getPlayerInfo(e,t){console.log("【VideoAdGuard】[BilibiliService] Getting player info for bvid:",e,"cid:",t);const o={bvid:e,cid:t},n=await i.WbiUtils.encWbi(o),r=await this.fetchWithCookie("https://api.bilibili.com/x/player/wbi/v2",n);return console.log("【VideoAdGuard】[BilibiliService] Player info result:",r),r}static async getCaptions(e){console.log("【VideoAdGuard】[BilibiliService] Getting captions from URL:",e);const t=await fetch(e),o=await t.json();return console.log("【VideoAdGuard】[BilibiliService] Captions result:",o),o}}},503:(e,t,o)=>{var i,n,r,s,a;i=o(939),n=o(151).utf8,r=o(206),s=o(151).bin,(a=function(e,t){e.constructor==String?e=t&&"binary"===t.encoding?s.stringToBytes(e):n.stringToBytes(e):r(e)?e=Array.prototype.slice.call(e,0):Array.isArray(e)||e.constructor===Uint8Array||(e=e.toString());for(var o=i.bytesToWords(e),c=8*e.length,l=1732584193,d=-271733879,u=-1732584194,g=271733878,p=0;p<o.length;p++)o[p]=16711935&(o[p]<<8|o[p]>>>24)|4278255360&(o[p]<<24|o[p]>>>8);o[c>>>5]|=128<<c%32,o[14+(c+64>>>9<<4)]=c;var h=a._ff,f=a._gg,m=a._hh,b=a._ii;for(p=0;p<o.length;p+=16){var y=l,w=d,v=u,A=g;l=h(l,d,u,g,o[p+0],7,-680876936),g=h(g,l,d,u,o[p+1],12,-389564586),u=h(u,g,l,d,o[p+2],17,606105819),d=h(d,u,g,l,o[p+3],22,-1044525330),l=h(l,d,u,g,o[p+4],7,-176418897),g=h(g,l,d,u,o[p+5],12,1200080426),u=h(u,g,l,d,o[p+6],17,-1473231341),d=h(d,u,g,l,o[p+7],22,-45705983),l=h(l,d,u,g,o[p+8],7,1770035416),g=h(g,l,d,u,o[p+9],12,-1958414417),u=h(u,g,l,d,o[p+10],17,-42063),d=h(d,u,g,l,o[p+11],22,-1990404162),l=h(l,d,u,g,o[p+12],7,1804603682),g=h(g,l,d,u,o[p+13],12,-40341101),u=h(u,g,l,d,o[p+14],17,-1502002290),l=f(l,d=h(d,u,g,l,o[p+15],22,1236535329),u,g,o[p+1],5,-165796510),g=f(g,l,d,u,o[p+6],9,-1069501632),u=f(u,g,l,d,o[p+11],14,643717713),d=f(d,u,g,l,o[p+0],20,-373897302),l=f(l,d,u,g,o[p+5],5,-701558691),g=f(g,l,d,u,o[p+10],9,38016083),u=f(u,g,l,d,o[p+15],14,-660478335),d=f(d,u,g,l,o[p+4],20,-405537848),l=f(l,d,u,g,o[p+9],5,568446438),g=f(g,l,d,u,o[p+14],9,-1019803690),u=f(u,g,l,d,o[p+3],14,-187363961),d=f(d,u,g,l,o[p+8],20,1163531501),l=f(l,d,u,g,o[p+13],5,-1444681467),g=f(g,l,d,u,o[p+2],9,-51403784),u=f(u,g,l,d,o[p+7],14,1735328473),l=m(l,d=f(d,u,g,l,o[p+12],20,-1926607734),u,g,o[p+5],4,-378558),g=m(g,l,d,u,o[p+8],11,-2022574463),u=m(u,g,l,d,o[p+11],16,1839030562),d=m(d,u,g,l,o[p+14],23,-35309556),l=m(l,d,u,g,o[p+1],4,-1530992060),g=m(g,l,d,u,o[p+4],11,1272893353),u=m(u,g,l,d,o[p+7],16,-155497632),d=m(d,u,g,l,o[p+10],23,-1094730640),l=m(l,d,u,g,o[p+13],4,681279174),g=m(g,l,d,u,o[p+0],11,-358537222),u=m(u,g,l,d,o[p+3],16,-722521979),d=m(d,u,g,l,o[p+6],23,76029189),l=m(l,d,u,g,o[p+9],4,-640364487),g=m(g,l,d,u,o[p+12],11,-421815835),u=m(u,g,l,d,o[p+15],16,530742520),l=b(l,d=m(d,u,g,l,o[p+2],23,-995338651),u,g,o[p+0],6,-198630844),g=b(g,l,d,u,o[p+7],10,1126891415),u=b(u,g,l,d,o[p+14],15,-1416354905),d=b(d,u,g,l,o[p+5],21,-57434055),l=b(l,d,u,g,o[p+12],6,1700485571),g=b(g,l,d,u,o[p+3],10,-1894986606),u=b(u,g,l,d,o[p+10],15,-1051523),d=b(d,u,g,l,o[p+1],21,-2054922799),l=b(l,d,u,g,o[p+8],6,1873313359),g=b(g,l,d,u,o[p+15],10,-30611744),u=b(u,g,l,d,o[p+6],15,-1560198380),d=b(d,u,g,l,o[p+13],21,1309151649),l=b(l,d,u,g,o[p+4],6,-145523070),g=b(g,l,d,u,o[p+11],10,-1120210379),u=b(u,g,l,d,o[p+2],15,718787259),d=b(d,u,g,l,o[p+9],21,-343485551),l=l+y>>>0,d=d+w>>>0,u=u+v>>>0,g=g+A>>>0}return i.endian([l,d,u,g])})._ff=function(e,t,o,i,n,r,s){var a=e+(t&o|~t&i)+(n>>>0)+s;return(a<<r|a>>>32-r)+t},a._gg=function(e,t,o,i,n,r,s){var a=e+(t&i|o&~i)+(n>>>0)+s;return(a<<r|a>>>32-r)+t},a._hh=function(e,t,o,i,n,r,s){var a=e+(t^o^i)+(n>>>0)+s;return(a<<r|a>>>32-r)+t},a._ii=function(e,t,o,i,n,r,s){var a=e+(o^(t|~i))+(n>>>0)+s;return(a<<r|a>>>32-r)+t},a._blocksize=16,a._digestsize=16,e.exports=function(e,t){if(null==e)throw new Error("Illegal argument "+e);var o=i.wordsToBytes(a(e,t));return t&&t.asBytes?o:t&&t.asString?s.bytesToString(o):i.bytesToHex(o)}},939:e=>{var t,o;t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o={rotl:function(e,t){return e<<t|e>>>32-t},rotr:function(e,t){return e<<32-t|e>>>t},endian:function(e){if(e.constructor==Number)return 16711935&o.rotl(e,8)|4278255360&o.rotl(e,24);for(var t=0;t<e.length;t++)e[t]=o.endian(e[t]);return e},randomBytes:function(e){for(var t=[];e>0;e--)t.push(Math.floor(256*Math.random()));return t},bytesToWords:function(e){for(var t=[],o=0,i=0;o<e.length;o++,i+=8)t[i>>>5]|=e[o]<<24-i%32;return t},wordsToBytes:function(e){for(var t=[],o=0;o<32*e.length;o+=8)t.push(e[o>>>5]>>>24-o%32&255);return t},bytesToHex:function(e){for(var t=[],o=0;o<e.length;o++)t.push((e[o]>>>4).toString(16)),t.push((15&e[o]).toString(16));return t.join("")},hexToBytes:function(e){for(var t=[],o=0;o<e.length;o+=2)t.push(parseInt(e.substr(o,2),16));return t},bytesToBase64:function(e){for(var o=[],i=0;i<e.length;i+=3)for(var n=e[i]<<16|e[i+1]<<8|e[i+2],r=0;r<4;r++)8*i+6*r<=8*e.length?o.push(t.charAt(n>>>6*(3-r)&63)):o.push("=");return o.join("")},base64ToBytes:function(e){e=e.replace(/[^A-Z0-9+\/]/gi,"");for(var o=[],i=0,n=0;i<e.length;n=++i%4)0!=n&&o.push((t.indexOf(e.charAt(i-1))&Math.pow(2,-2*n+8)-1)<<2*n|t.indexOf(e.charAt(i))>>>6-2*n);return o}},e.exports=o},974:function(e,t,o){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WbiUtils=void 0;const n=i(o(503));class r{static getMixinKey(e){return this.mixinKeyEncTab.map((t=>e[t])).join("").slice(0,32)}static async getWbiKeys(){const e="wbi_cache",t=await chrome.storage.local.get(e);if(t[e]){const o=t[e],i=(new Date).setHours(0,0,0,0);if(o.timestamp>=i)return[o.img_key,o.sub_key]}const o=await fetch("https://api.bilibili.com/x/web-interface/nav",{headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"}}),i=(await o.json()).data.wbi_img,n=i.img_url.slice(i.img_url.lastIndexOf("/")+1,i.img_url.lastIndexOf(".")),r=i.sub_url.slice(i.sub_url.lastIndexOf("/")+1,i.sub_url.lastIndexOf(".")),s={img_key:n,sub_key:r,timestamp:Date.now()};return await chrome.storage.local.set({[e]:s}),[n,r]}static async encWbi(e){const[t,o]=await this.getWbiKeys(),i=this.getMixinKey(t+o),r={...e,wts:Math.round(Date.now()/1e3)},s=Object.keys(r).sort().map((e=>{const t=String(r[e]).replace(/[!'()*]/g,"");return`${encodeURIComponent(e)}=${encodeURIComponent(t)}`})).join("&"),a=(0,n.default)(s+i);return{...r,w_rid:a}}}t.WbiUtils=r,r.mixinKeyEncTab=[46,47,18,2,53,8,23,32,15,50,10,31,58,3,45,35,27,43,5,49,33,9,42,19,29,28,14,39,12,38,41,13,37,48,7,16,24,55,40,61,26,17,0,1,60,51,30,4,22,25,54,21,56,59,6,63,57,62,11,36,20,34,44,52]}},t={};function o(i){var n=t[i];if(void 0!==n)return n.exports;var r=t[i]={exports:{}};return e[i].call(r.exports,r,r.exports,o),r.exports}(()=>{"use strict";const e=o(237),t=o(27);class i{static async getCurrentBvid(){const e=window.location.pathname.match(/BV[\w]+/);if(e)return e[0];const t=new URLSearchParams(window.location.search).get("bvid");if(t)return t;throw new Error("未找到视频ID")}static async analyze(){try{const o=document.querySelector(".skip-ad-button10032");o&&o.remove();const n=await this.getCurrentBvid(),r=await e.BilibiliService.getVideoInfo(n),s=await e.BilibiliService.getComments(n),a=await e.BilibiliService.getPlayerInfo(n,r.cid);if(!a.subtitle?.subtitles?.length)return console.log("【VideoAdGuard】当前视频无字幕，无法检测"),void(this.adDetectionResult="当前视频无字幕，无法检测");const c="https:"+a.subtitle.subtitles[0].subtitle_url,l=await e.BilibiliService.getCaptions(c),d={};l.body.forEach(((e,t)=>{d[t]=e.content}));const u=await t.AIService.detectAd({title:r.title,topComment:s.upper?.top?.content?.message||null,captions:d});let g;try{const e="string"==typeof u?u.replace(/\s+/g,"").replace(/\\/g,"").replace(/json/g,"").replace(/```/g,""):JSON.stringify(u);if(g=JSON.parse(e),"boolean"!=typeof g.exist||!Array.isArray(g.index_lists))throw new Error("返回数据格式错误");if(g.exist&&!g.index_lists.every((e=>Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1])))throw new Error("广告时间段格式错误")}catch(e){throw console.error("【VideoAdGuard】大模型返回数据JSON解析失败:",e),new Error(`AI返回数据格式错误: ${e.message}`)}if(g.exist){console.log("【VideoAdGuard】检测到广告片段:",JSON.stringify(g.index_lists));const e=this.index2second(g.index_lists,l.body);i.adTimeRanges=e,this.adDetectionResult=`发现${e.length}处广告：${e.map((([e,t])=>`${this.second2time(e)}~${this.second2time(t)}`)).join(" | ")}`,this.injectSkipButton()}else console.log("【VideoAdGuard】无广告内容"),this.adDetectionResult="无广告内容"}catch(e){console.error("【VideoAdGuard】分析失败:",e),this.adDetectionResult="分析失败："+e.message}}static index2second(e,t){return e.map((e=>[t[e[0]]?.from||0,t[e[e.length-1]]?.to||0]))}static second2time(e){const t=Math.floor(e/3600),o=Math.floor(e%3600/60),i=Math.floor(e%60);return`${t>0?t+":":""}${o.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}static injectSkipButton(){const e=document.querySelector(".bpx-player-control-bottom");if(!e)return;const t=document.createElement("button");t.className="skip-ad-button10032",t.textContent="跳过广告",t.style.cssText="\n      font-size: 14px;\n      position: absolute;\n      right: 20px;\n      bottom: 100px;\n      z-index: 999;\n      padding: 4px 4px;\n      color: #000000; \n      font-weight: bold;\n      background: rgba(255, 255, 255, 0.7);\n      border: none;\n      border-radius: 4px;\n      cursor: pointer;\n    ",e.appendChild(t);const o=document.querySelector("video");o?t.addEventListener("click",(()=>{const e=o.currentTime;console.log("【VideoAdGuard】当前时间:",e);const t=this.adTimeRanges.find((([t,o])=>e>=t&&e<o));t&&(o.currentTime=t[1],console.log("【VideoAdGuard】跳转时间:",t[1]))})):console.error("未找到视频元素")}}i.adDetectionResult=null,i.adTimeRanges=[],chrome.runtime.onMessage.addListener(((e,t,o)=>{"GET_AD_INFO"===e.type&&o({adInfo:i.adDetectionResult||"广告检测尚未完成",timestamp:Date.now()})})),window.addEventListener("load",(()=>i.analyze()));let n=location.href;new MutationObserver((()=>{const e=location.href;e!==n&&(n=e,console.log("【VideoAdGuard】URL changed:",e),i.analyze())})).observe(document,{subtree:!0,childList:!0}),window.addEventListener("popstate",(()=>{console.log("【VideoAdGuard】History changed:",location.href),i.analyze()}))})()})();